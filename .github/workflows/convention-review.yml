name: Convention Review

on:
  pull_request:
    paths:
      - '**.sql'
      - '**.yml'
      - '**.yaml'

jobs:
  review-conventions:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v44
        with:
          files: |
            **.sql
            **.yml
            **.yaml

      - name: Review with Claude
        if: steps.changed-files.outputs.any_changed == 'true'
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          model: claude-sonnet-4-20250514
          prompt: |
            Review the following changed files for convention violations.

            Use MCP to fetch the convention documents from Notion:
            - Metric Naming Convention: page ID 2eab84e92e7780029a3de4be7927d0f0
            - SQL Style Guide: page ID 2eab84e92e77808cadf5ed14c3298932

            Changed files to review:
            ${{ steps.changed-files.outputs.all_changed_files }}

            Follow the review prompt in prompts/review-conventions.md

            Post your findings as a PR comment. If critical violations exist,
            request changes. Otherwise, approve or comment based on severity.

          mcp_config: |
            {
              "mcpServers": {
                "notion": {
                  "command": "npx",
                  "args": ["-y", "@notionhq/notion-mcp-server"],
                  "env": {
                    "NOTION_TOKEN": "${{ secrets.NOTION_TOKEN }}"
                  }
                }
              }
            }

          # Optional: Only comment, don't block
          # Set to 'true' to enable blocking on critical violations
          allowed_tools: |
            Read
            Glob
            Grep
            mcp__notion
